{% extends "base.html" %}
{% block content %}
<div class="panel panel-info">
    <div class="panel-body text-center">
        <div class="col-md-4" style="margin-top: 5px; margin-bottom: 5px">
            <button id="toggleDragButton" class="btn {%if not mobile%}btn-lg{%endif%} btn-success">Dragging Enabled</button>
        </div>
        <div class="col-md-4" style="margin-top: 5px; margin-bottom: 5px">
            <button id="saveGridButton" class="btn {%if not mobile%}btn-lg{%endif%} btn-success">Save Changes</button>
        </div>
        <div class="dropdown col-md-4" style="margin-top: 5px; margin-bottom: 5px">
            <button class="btn btn-primary {%if not mobile%}btn-lg{%endif%} dropdown-toggle" type="button" data-toggle="dropdown">Add a Script      <span class="caret"></span></button>
            <ul class="dropdown-menu">
            {% for script in scripts %}
                <li><a href="#" class="addScriptButton" id="{{script.id}}">{{script.name}}</a></li>
            {% endfor %}
            </ul>
        </div>
    </div>
</div>
<div class="gridster">
    <ul></ul>
</div>
<div style="height: 200px"></div> <!-- so the selectors bar doesn't get cut off -->
<div id="selectors" class="footer navbar-fixed-bottom" style="display:none; background-color: #f5f5f5; border-style: solid; border-top: thick single;">    
    <a href="#" id="closeSelectorsButton" style="float:right; margin-right: 5px; color: black; z-index: 3;">&times;</a>
    <div id="selectorsContent" class="container" style="margin-top: 5px">
        <div class="panel-header">
            <strong>Stuff in here</strong>
        </div>
        <div class="panel-body">
            <p>Buttons</p>
        </div>
    </div>
    <button class="btn btn-success btn-lg btn-block" type="button" style="margin-bottom:5px; margin-top:5px; margin-left:auto; margin-right:auto ; width:80%">Play Script</button>
</div>
<script>
$( document ).ready(function() {
    function serializeParams(widget, wgd){
        return { script_id: widget.attr("id"), col: wgd.col, row: wgd.row, size_x: wgd.size_x, size_y: wgd.size_y }
    }

    function widgetHTMLForScript(script){
        var scriptHTML = '<li id=' + script.id + ' class="btn scriptButton ' + script.color + '" data-sizex="1" data-sizey="2" style="white-space: normal; word-wrap: break-word;">' + 
            '<a href="#" class="closeScriptButton" style="float:right; margin-right: 5px; color: white; z-index: 3;">&times;</a><strong>'
             + script.name + '</strong><p>' + script.script + '</p></li>';
        return scriptHTML;
    }

    function scriptForId(id){
        var i;
        var script = null;
        for(i = 0; i < scripts.length; i++){
            if(scripts[i].id == id){
                script = scripts[i];
                break;
            }
        }
        return script;
    }

    function selectorForId(id){
        var i;
        var selector = null;
        for(i = 0; i < selectors.length; i++){
            if(selectors[i].id == id){
                selector = selectors[i];
                break;
            }
        }
        return selector;
    }

    var dims = [300, 180];
    var margs = [10, 10];

    {% if mobile %}
    dims = [100, 100];
    margs = [5, 5];
    {% endif %}

	var gridster = $(".gridster ul").gridster({
        widget_margins: margs,
        widget_base_dimensions: dims,
        max_cols: 3,
        serialize_params: serializeParams
    }).data("gridster");

    var scripts = [];
    var selectors = [];
    $.get({
        url: "/getScripts",
        dataType: "json",
        success: function(response){
            scripts = response["scripts"];
            selectors = response["selectors"];

            console.log(selectors);
        }
    });

    $.get({
        url: "/layout",
        "dataType": "json",
        success: function(response){
            var layout = response;
            layout["scripts"] = JSON.parse(layout["scripts"]);
            var gridScripts = layout["scripts"];
            gridScripts = Gridster.sort_by_row_and_col_asc(gridScripts);
            gridster.remove_all_widgets();

            $.each(gridScripts, function() {
                var script = scriptForId(this["script_id"]);
                var scriptHTML = widgetHTMLForScript(script);
                gridster.add_widget(scriptHTML, this["size_x"], this["size_y"], this["col"], this["row"]);
            });
        }
    })

    $("#toggleDragButton").click(function(){
        var button = $("#toggleDragButton");
        if(button.hasClass("btn-success")){
            button.removeClass("btn-success").addClass("btn-danger");
            button.html("Dragging Disabled");
            gridster.disable();
        }else{
            button.removeClass("btn-danger").addClass("btn-success");
            button.html("Dragging Enabled");
            gridster.enable();
        }
    });

    $("#closeSelectorsButton").click(function(){
        $("#selectors").hide();
    });

    $("#saveGridButton").click(function(){
        var out = gridster.serialize();
        console.log(out);
        $.ajax({
            url: "/layout",
            data: JSON.stringify(out),
            type: "POST",
            dataType: "json",
            contentType: "application/json",
            success: function(response){

            },
            error: function(error){
                window.alert(error);
            }
        });
    });

    $(".addScriptButton").click(function(){
        var script = scriptForId(this.id);
        if(script != null){
            var scriptHTML = widgetHTMLForScript(script);
            gridster.add_widget(scriptHTML, 1, 1);
        }
    });

    $(document).on("click", ".closeScriptButton", function(event){
        var widget = $(this).closest("li");
        gridster.remove_widget(widget);
        event.stopPropagation(); // stops the .scriptButton from receiving a click too
    });

    $(document).on("click", ".scriptButton", function(){
        var widget = $(this);
        var script = scriptForId(widget.attr("id"));
        $("#selectorsContent").empty();
        var selectorsHTML = "";
        var i;
        var colSize = 12 / script.selectors.length;
        // determine how to lay out the selectors
        if(script.selectors.length == 5){
            colSize = 2;
        }else if(script.selectors.length > 6){
            colSize = 1;
        }

        for(i = 0; i < script.selectors.length; i++){
            var selector = selectorForId(script.selectors[i]);
            console.log(script.selectors[i]);
            selectorsHTML += '<div class="col-md-' + colSize + '">' + selector.html + '</div>';
        }
        $("#selectorsContent").html(selectorsHTML);
        $("#selectors").show();
    });

    {% for selector in selectors %}
    	{{selector.js | safe}}
    {% endfor %}
});
</script>
{% endblock %}